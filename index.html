<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifikasi Discord</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .captcha-canvas {
            background-image: url('data:image/svg+xml;utf8,<svg width="200" height="70" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="p" width="4" height="4" patternUnits="userSpaceOnUse"><path d="M0 0h4v4H0z" fill="none"/><path d="M0 0l4 4m-4 0l4-4" stroke="%23374151" stroke-width=".5"/></pattern></defs><rect width="100%" height="100%" fill="url(%23p)"/></svg>');
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans antialiased flex items-center justify-center min-h-screen p-4">

    <div id="container" class="w-full max-w-md bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-2xl shadow-blue-500/10 p-8 border border-gray-700">
        
        <div class="text-center mb-6">
            <svg id="icon-loading" class="mx-auto h-12 w-12 text-blue-500 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <svg id="icon-valid" class="hidden mx-auto h-12 w-12 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <svg id="icon-invalid" class="hidden mx-auto h-12 w-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        </div>

        <h1 id="main-title" class="text-2xl font-bold text-center text-gray-100 mb-2">Memvalidasi Link...</h1>
        <p id="sub-title" class="text-center text-gray-400 mb-8">Harap tunggu sebentar.</p>

        <div id="captcha-container" class="hidden">
            <div class="flex justify-center mb-4">
                <canvas id="captchaCanvas" width="200" height="70" class="rounded-lg captcha-canvas border border-gray-600"></canvas>
            </div>
            <div class="flex items-center space-x-2 mb-4">
                <input type="text" id="captchaInput" placeholder="Masukkan teks di atas" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                <button onclick="drawCaptcha()" class="p-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M20 4h-5v5M4 20h5v-5"></path></svg>
                </button>
            </div>
            <button id="submitButton" onclick="verifyCaptcha()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                <span id="spinner" class="hidden w-5 h-5 mr-3 -ml-1 text-white animate-spin">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
                Verifikasi
            </button>
        </div>

        <div id="result" class="text-center mt-4"></div>
    </div>

    <script>
        let captchaText = '';
        let userId = '';
        let guildId = '';

        const titleEl = document.getElementById('main-title');
        const subTitleEl = document.getElementById('sub-title');
        const captchaContainer = document.getElementById('captcha-container');
        const resultDiv = document.getElementById('result');
        const iconLoading = document.getElementById('icon-loading');
        const iconValid = document.getElementById('icon-valid');
        const iconInvalid = document.getElementById('icon-invalid');

        function generateCaptchaText() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function drawCaptcha() {
            const canvas = document.getElementById('captchaCanvas');
            const ctx = canvas.getContext('2d');
            captchaText = generateCaptchaText();
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = 'bold 36px Inter';
            ctx.fillStyle = '#9CA3AF';
            
            for (let i = 0; i < captchaText.length; i++) {
                ctx.save();
                ctx.translate(20 + i * 28, 45);
                ctx.rotate((Math.random() - 0.5) * 0.4);
                ctx.fillText(captchaText[i], 0, 0);
                ctx.restore();
            }

            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(Math.random() * canvas.width, Math.random() * canvas.height);
                ctx.lineTo(Math.random() * canvas.width, Math.random() * canvas.height);
                ctx.strokeStyle = '#4B5563';
                ctx.stroke();
            }
        }

        async function verifyCaptcha() {
            const captchaInput = document.getElementById('captchaInput');
            const submitButton = document.getElementById('submitButton');
            const spinner = document.getElementById('spinner');

            if (captchaInput.value.toLowerCase() !== captchaText.toLowerCase()) {
                resultDiv.textContent = 'Captcha salah, silakan coba lagi.';
                resultDiv.className = 'text-red-400 mt-4 text-center';
                captchaInput.value = '';
                drawCaptcha();
                return;
            }
            
            submitButton.disabled = true;
            spinner.classList.remove('hidden');
            resultDiv.textContent = 'Memproses verifikasi...';
            resultDiv.className = 'text-gray-400 mt-4 text-center';

            // --- PERUBAHAN UTAMA ADA DI SINI ---
            // GANTI URL ini dengan URL backend Anda (dari ngrok untuk tes, atau dari server Anda).
            const backendUrl = 'http://localhost:3000/verify'; 

            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, guildId }),
                });

                const data = await response.json();

                if (data.success) {
                    captchaContainer.classList.add('hidden');
                    titleEl.textContent = 'Verifikasi Berhasil!';
                    subTitleEl.textContent = 'Akun anda telah berhasil di verifikasi, Silakan tutup halaman ini dan kembali pada server discord.';
                    resultDiv.textContent = '';
                    iconLoading.classList.add('hidden');
                    iconValid.classList.remove('hidden');
                } else {
                    throw new Error(data.message || 'Gagal menghubungi server verifikasi.');
                }

            } catch (error) {
                resultDiv.textContent = `Terjadi kesalahan: ${error.message}`;
                resultDiv.className = 'text-red-400 mt-4 text-center';
                submitButton.disabled = false;
                drawCaptcha();
            } finally {
                spinner.classList.add('hidden');
            }
        }

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            userId = params.get('userId');
            guildId = params.get('guildId');

            setTimeout(() => {
                if (userId && guildId) {
                    iconLoading.classList.add('hidden');
                    iconValid.classList.remove('hidden');
                    titleEl.textContent = 'Verifikasi Diri Anda';
                    subTitleEl.textContent = 'Buktikan bahwa Anda adalah manusia dengan menyelesaikan captcha di bawah.';
                    captchaContainer.classList.remove('hidden');
                    drawCaptcha();
                } else {
                    iconLoading.classList.add('hidden');
                    iconInvalid.classList.remove('hidden');
                    titleEl.textContent = 'URL Tidak Valid';
                    subTitleEl.textContent = 'Pastikan Anda membuka link ini dari Discord. Parameter userId atau guildId tidak ditemukan.';
                }
            }, 1000);
        };
    </script>
</body>
</html>


